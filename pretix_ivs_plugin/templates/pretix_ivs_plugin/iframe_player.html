<!DOCTYPE html>
<html>
<head>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: black; overflow: hidden; }
        #video-player { width: 100%; height: 100%; }
    </style>
    <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?version=4.8.0&features=es2015%2Ces2016%2Ces2017%2CURL%2CBlob%2CObject.assign%2CIntersectionObserver%2CIntersectionObserverEntry%2CPromise"></script>
    <script>
        (function() {
            const needsPolyfill = typeof FileReader === 'undefined' || 
                                 (new FileReader().readAsArrayBuffer.toString().includes('unimplemented'));

            if (needsPolyfill) {
                console.warn("Applying functional FileReader.readAsArrayBuffer polyfill...");
                
                window.FileReader = function() {
                    this.onload = null;
                    this.onerror = null;
                    this.result = null;

                    this.readAsArrayBuffer = function(blob) {
                        const reader = this;
                        // Use Fetch/Response API to convert Blob to ArrayBuffer
                        // Most browsers old enough to lack FileReader but new enough for IVS
                        // will support the Response object.
                        if (typeof Response !== 'undefined') {
                            new Response(blob).arrayBuffer()
                                .then(buffer => {
                                    reader.result = buffer;
                                    if (reader.onload) reader.onload({ target: reader });
                                })
                                .catch(err => {
                                    if (reader.onerror) reader.onerror(err);
                                });
                        } else {
                            console.error("Environment too old for ArrayBuffer conversion.");
                        }
                    };

                    // Add empty stubs for other methods to prevent IVS from crashing on check
                    this.readAsDataURL = function() {};
                    this.readAsText = function() {};
                };
            }
        })();
    </script>
    <script src="https://player.live-video.net/1.16.0/amazon-ivs-player.min.js"></script>
</head>
<body>
    <video id="video-player" controls playsinline></video>
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const streamUrl = urlParams.get('url');
            let retryTimeout;

            function init() {
                if (typeof IVSPlayer === 'undefined') {
                    console.error("IVS library not found");
                    return;
                }
                const PlayerFactory = IVSPlayer.create ? IVSPlayer : window.IVSPlayer;
                if (!PlayerFactory.isPlayerSupported || !streamUrl) return;

                const player = IVSPlayer.create({
                    optimizeBackgroundPlayback: { enabled: true }
                });
                player.attachHTMLVideoElement(document.getElementById('video-player'));

                player.addEventListener(IVSPlayer.PlayerEventType.ERROR, (err) => {
                    console.warn("Player Error:", err.message);
                    if (err.code === 404 || err.message.includes('playlist')) { 
                        console.log("Stream might be offline. Retrying in 10 seconds...");
                        clearTimeout(retryTimeout);
                        retryTimeout = setTimeout(() => {
                            player.load(streamUrl);
                            player.play();
                        }, 10000);
                    }
                });

                player.addEventListener(IVSPlayer.PlayerState.PLAYING, () => {
                    console.log("Stream is live!");
                    clearTimeout(retryTimeout);
                });

                player.load(streamUrl);
                player.play();
            }

            if (document.readyState === 'complete') {
                init();
            } else {
                window.addEventListener('load', init);
            }
        })();
    </script>
</body>
</html>
